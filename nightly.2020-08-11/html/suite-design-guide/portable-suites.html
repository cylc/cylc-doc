

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Portable Suites &mdash; Cylc nightly.2020-08-11 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cylc.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/cylc-favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/js/minicylc.js"></script>
        <script src="../_static/js/spoiler.js"></script>
        <script src="../_static/js/cylc.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Roadmap" href="roadmap.html" />
    <link rel="prev" title="Efficiency And Maintainability" href="efficiency.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/cylc-logo-white.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                nightly.2020-08-11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table Of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction: How Cylc Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Suite Design Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="style-guide.html">Style Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-principles.html">Basic Principles</a></li>
<li class="toctree-l2"><a class="reference internal" href="efficiency.html">Efficiency And Maintainability</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Portable Suites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-jinja2-site-variable">The Jinja2 SITE Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-include-files">Site Include-Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-specific-graphs">Site-Specific Graphs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inlined-site-switching">Inlined Site-Switching</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-specific-suite-variables">Site-Specific Suite Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-specific-optional-suite-configs">Site-Specific Optional Suite Configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-agnostic-file-paths-in-app-configs">Site-Agnostic File Paths in App Configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#site-specific-optional-app-configs">Site-Specific Optional App Configs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#an-example">An Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#collaborative-development-model">Collaborative Development Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#research-to-operations-transition">Research-To-Operations Transition</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cylc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Suite Design Guide</a> &raquo;</li>
        
      <li>Portable Suites</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/suite-design-guide/portable-suites.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="portable-suites">
<span id="portable-suites-label"></span><h1>Portable Suites<a class="headerlink" href="#portable-suites" title="Permalink to this headline">¶</a></h1>
<p>A <em>portable</em> or <em>interoperable</em> suite can run “out of the box” at
different sites, or in different environments such as research and operations
within a site.  For convenience we just use the term <em>site portability</em>.</p>
<p>Lack of portability is a major barrier to collaborative development when
sites need to run more or less the same workflow, because it is very
difficult to translate changes manually between large, complicated suites.</p>
<p>Most suites are riddled with site-specific details such as local build
configurations, file paths, host names, and batch scheduler directives, etc.;
but it is possible to cleanly factor all this out to make a portable suite.
Significant variations in workflow structure can even be accommodated quite
easily. If the site workflows are <em>too different</em>, however, you may decide
that it is appropriate for each site to maintain separate suites.</p>
<p>The recommended way to do this, which we expand on below, is:</p>
<ul class="simple">
<li><p>Put all site-specific settings in include-files loaded at the end
of a generic “core” suite definition.</p></li>
<li><p>Use “optional” app config files for site-specific variations
in the core suite’s Rose apps.</p></li>
<li><p>(Make minimal use of inlined site switches too, if necessary).</p></li>
<li><p>When referencing files, reference them within the suite structure and
use an install task to link external files in.</p></li>
</ul>
<p>The result should actually be tidier than the original in one respect: all
the messy platform-specific resource directives etc., will be hidden away in
the site include-files.</p>
<div class="section" id="the-jinja2-site-variable">
<h2>The Jinja2 SITE Variable<a class="headerlink" href="#the-jinja2-site-variable" title="Permalink to this headline">¶</a></h2>
<p>First a suite Jinja2 variable called <code class="docutils literal notranslate"><span class="pre">SITE</span></code> should be set to the site
name, either in <code class="docutils literal notranslate"><span class="pre">rose-suite.conf</span></code>, or in the suite definition itself
(perhaps automatically, by querying the local environment in some way).</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="ch">#!Jinja2</span>
<span class="cp">{% set SITE = &quot;niwa&quot; %}</span>
<span class="c1">#...</span>
</pre></div>
</div>
<p>This will be used to select site-specific configuration, as described below.</p>
</div>
<div class="section" id="site-include-files">
<h2>Site Include-Files<a class="headerlink" href="#site-include-files" title="Permalink to this headline">¶</a></h2>
<p>If a section heading in a suite.rc file is repeated the items under it simply
add to or override those defined under the same section earlier in the file
(but note <a class="reference internal" href="roadmap.html#list-item-override-in-site-include-files"><span class="std std-ref">List Item Override In Site Include-Files</span></a>).
For example, this task definition:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[runtime]</span>
    <span class="nt">[[foo]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> run-foo.sh</span>
        <span class="nt">[[[remote]]]</span>
            <span class="nv">host </span><span class="o">=</span><span class="s"> hpc1.niwa.co.nz</span>
</pre></div>
</div>
<p>can equally be written like this:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[runtime]</span>  <span class="c1"># Part 1 (site-agnostic).</span>
    <span class="nt">[[foo]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> run-foo.sh</span>
<span class="nt">[runtime]</span>  <span class="c1"># Part 2 (site-specific).</span>
    <span class="nt">[[foo]]</span>
        <span class="nt">[[[remote]]]</span>
            <span class="nv">host </span><span class="o">=</span><span class="s"> hpc1.niwa.co.nz</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If Part 2 had also defined <code class="docutils literal notranslate"><span class="pre">script</span></code> the new value would
override the original. It can sometimes be useful to set a widely used
default and override it in a few cases, but be aware that this can
make it more difficult to determine the origin of affected values.</p>
</div>
<p>In this way all site-specific <code class="docutils literal notranslate"><span class="pre">[runtime]</span></code> settings, with their
respective sub-section headings, can be moved to the end of the file, and then
out into an include-file (file inclusion is essentially just literal inlining):</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1">#...</span>
<span class="cp">{% set SITE = &quot;niwa&quot; %}</span>

<span class="c1"># Core site-agnostic settings:</span>
<span class="c1">#...</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[foo]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> run-foo.sh</span>
<span class="c1">#...</span>

<span class="c1"># Site-specific settings:</span>
<span class="cp">{% include &#39;site/&#39; ~ SITE ~ &#39;.rc&#39; %}</span>
</pre></div>
</div>
<p>where the site include-file <code class="docutils literal notranslate"><span class="pre">site/niwa.rc</span></code> contains:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># site/niwa.rc</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[foo]]</span>
        <span class="nt">[[[remote]]]</span>
            <span class="nv">host </span><span class="o">=</span><span class="s"> hpc1.niwa.co.nz</span>
</pre></div>
</div>
</div>
<div class="section" id="site-specific-graphs">
<h2>Site-Specific Graphs<a class="headerlink" href="#site-specific-graphs" title="Permalink to this headline">¶</a></h2>
<p>Repeated <code class="docutils literal notranslate"><span class="pre">graph</span></code> strings under the same graph section headings are
always additive (graph strings are the only exception to the normal repeat item
override semantics). So, for instance, this graph:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[scheduling]</span>
    <span class="nv">initial cycle point </span><span class="o">=</span><span class="s"> 2025</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">P1Y </span><span class="o">=</span><span class="s"> &quot;pre =&gt; model =&gt; post =&gt; niwa_archive&quot;</span>
</pre></div>
</div>
<p>can be written like this:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[scheduling]</span>
    <span class="nv">initial cycle point </span><span class="o">=</span><span class="s"> 2025</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">P1Y </span><span class="o">=</span><span class="s"> &quot;pre =&gt; model =&gt; post&quot;</span>
        <span class="nv">P1Y </span><span class="o">=</span><span class="s"> &quot;post =&gt; niwa_archive&quot;</span>
</pre></div>
</div>
<p>and again, the site-specific part can be taken out to a site include-file:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1">#...</span>
<span class="cp">{% set SITE = &quot;niwa&quot; %}</span>

<span class="c1"># Core site-agnostic settings.</span>
<span class="c1">#...</span>
<span class="nt">[scheduling]</span>
    <span class="nv">initial cycle point </span><span class="o">=</span><span class="s"> 2025</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">P1Y </span><span class="o">=</span><span class="s"> &quot;pre =&gt; model =&gt; post&quot;</span>
<span class="c1">#...</span>
<span class="c1"># Site-specific settings:</span>
<span class="cp">{% include &#39;site/&#39; ~ SITE ~ &#39;.rc&#39; %}</span>
</pre></div>
</div>
<p>where the site include-file <code class="docutils literal notranslate"><span class="pre">site/niwa.rc</span></code> contains:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># site/niwa.rc</span>
<span class="nt">[scheduling]</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">P1Y </span><span class="o">=</span><span class="s"> &quot;post =&gt; niwa_archive&quot;</span>
</pre></div>
</div>
<p>Note that the site-file graph needs to define the dependencies of the
site-specific tasks, and thus their points of connection to the core
suite - which is why the core task <code class="docutils literal notranslate"><span class="pre">post</span></code> appears in the graph here (if
<code class="docutils literal notranslate"><span class="pre">post</span></code> had any site-specific runtime settings, to get it to run at
this site, they would also be in the site-file).</p>
</div>
<div class="section" id="inlined-site-switching">
<span id="id1"></span><h2>Inlined Site-Switching<a class="headerlink" href="#inlined-site-switching" title="Permalink to this headline">¶</a></h2>
<p>It may be tempting to use inlined switch blocks throughout the suite instead of
site include-files, but <em>this is not recommended</em> - it is verbose and
untidy (the greater the number of supported sites, the bigger the
mess) and it exposes all site configuration to all users:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1">#...</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[model]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> run-model.sh</span>
<span class="c c-Multi">{# Site switch blocks not recommended:#}</span>
<span class="cp">{% if SITE == &#39;niwa&#39; %}</span>
        <span class="nt">[[[job]]]</span>
            <span class="nv">batch system </span><span class="o">=</span><span class="s"> loadleveler</span>
        <span class="nt">[[[directives]]]</span>
            <span class="c1"># NIWA Loadleveler directives...</span>
<span class="cp">{% elif SITE == &#39;metoffice&#39; %}</span>
        <span class="nt">[[[job]]]</span>
            <span class="nv">batch system </span><span class="o">=</span><span class="s"> pbs</span>
        <span class="nt">[[[directives]]]</span>
            <span class="c1"># Met Office PBS directives...</span>
<span class="cp">{% elif SITE == ... %}</span>
            <span class="c1">#...</span>
<span class="cp">{% else %}</span>
    <span class="cp">{{raise(&#39;Unsupported site: &#39; ~ SITE)}}</span>
<span class="cp">{% endif %}</span>
    <span class="c1">#...</span>
</pre></div>
</div>
<p>Inlined switches can be used, however, to configure exceptional behaviour at
one site without requiring the other sites to duplicate the default behaviour.
But be wary of accumulating too many of these switches:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># (core suite.rc file)</span>
<span class="c1">#...</span>
<span class="cp">{% if SITE == &#39;small&#39; %}</span>
   <span class="c c-Multi">{# We can&#39;t run 100 members... #}</span>
   <span class="cp">{% set ENSEMBLE_SIZE = 25 %}</span>
<span class="cp">{% else %}</span>
   <span class="c c-Multi">{# ...but everyone else can! #}</span>
   <span class="cp">{% set ENSEMBLE_SIZE = 100 %}</span>
<span class="cp">{% endif %}</span>
<span class="c1">#...</span>
</pre></div>
</div>
<p>Inlined switches can also be used to temporarily isolate a site-specific
change to a hitherto non site-specific part of the suite, thereby avoiding the
need to update all site include-files before getting agreement from the suite
owner and collaborators.</p>
</div>
<div class="section" id="site-specific-suite-variables">
<h2>Site-Specific Suite Variables<a class="headerlink" href="#site-specific-suite-variables" title="Permalink to this headline">¶</a></h2>
<p>It can sometimes be useful to set site-specific values of suite variables that
aren’t exposed to users via <code class="docutils literal notranslate"><span class="pre">rose-suite.conf</span></code>. For example, consider
a suite that can run a special post-processing workflow of some kind at sites
where IDL is available. The IDL-dependence switch can be set per site like this:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1">#...</span>
<span class="cp">{% from SITE ~ &#39;-vars.rc&#39; import HAVE_IDL, OTHER_VAR %}</span>
<span class="nv">R1 </span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  pre =&gt; model =&gt; post</span>
<span class="cp">{% if HAVE_IDL %}</span><span class="s2"></span>
<span class="s2">      post =&gt; idl-1 =&gt; idl-2 =&gt; idl-3</span>
<span class="cp">{% endif %}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>where for <code class="docutils literal notranslate"><span class="pre">SITE</span> <span class="pre">=</span> <span class="pre">niwa</span></code> the file <code class="docutils literal notranslate"><span class="pre">niwa-vars.rc</span></code> contains:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c c-Multi">{# niwa-vars.rc #}</span>
<span class="cp">{% set HAVE_IDL = True %}</span>
<span class="cp">{% set OTHER_VAR = &quot;the quick brown fox&quot; %}</span>
</pre></div>
</div>
<p>Note we are assuming there are significantly fewer options (IDL or not, in this
case) than sites, otherwise the IDL workflow should just go in the site
include-files of the sites that need it.</p>
</div>
<div class="section" id="site-specific-optional-suite-configs">
<h2>Site-Specific Optional Suite Configs<a class="headerlink" href="#site-specific-optional-suite-configs" title="Permalink to this headline">¶</a></h2>
<p>During development and testing of a portable suite you can use an optional Rose
suite config file to automatically set site-specific suite inputs and thereby
avoid the need to make manual changes every time you check out and run a new
version. The site switch itself has to be set of course, but there may be other
settings too such as model parameters for a standard local test domain. Just
put these settings in <code class="docutils literal notranslate"><span class="pre">opt/rose-suite-niwa.conf</span></code> (for site “niwa”)
and run the suite with <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">suite-run</span> <span class="pre">-O</span> <span class="pre">niwa</span></code>.</p>
</div>
<div class="section" id="site-agnostic-file-paths-in-app-configs">
<h2>Site-Agnostic File Paths in App Configs<a class="headerlink" href="#site-agnostic-file-paths-in-app-configs" title="Permalink to this headline">¶</a></h2>
<p>Where possible apps should be configured to reference files within the suite
structure itself rather than outside of it. This makes the apps themselves
portable and it becomes the job of the install task to ensure all required
source files are available within the suite structure e.g. via symlink into
the share directory. Additionally, by moving the responsibility of linking
files into the suite to an install task you gain the added benefit of knowing
if a file is missing at the start of a suite rather than part way into a run.</p>
</div>
<div class="section" id="site-specific-optional-app-configs">
<h2>Site-Specific Optional App Configs<a class="headerlink" href="#site-specific-optional-app-configs" title="Permalink to this headline">¶</a></h2>
<p>Typically a few but not all apps will need some site customization, e.g. for
local archive configuration, local science options, or whatever. To avoid
explicit site-customization of individual task-run command lines use Rose’s
built-in <em>optional app config</em> capability:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[runtime]</span>
    <span class="nt">[[root]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> rose task-run -v -O &#39;(</span><span class="cp">{{SITE}}</span><span class="s">)&#39;</span>
</pre></div>
</div>
<p>Normally a missing optional app config is considered to be an error, but the
round parentheses here mean the named optional config is optional - i.e.
use it if it exists, otherwise ignore.</p>
<p>With this setting in place we can simply add a <code class="docutils literal notranslate"><span class="pre">opt/rose-app-niwa.conf</span></code> to
any app that needs customization at <code class="docutils literal notranslate"><span class="pre">SITE</span> <span class="pre">=</span> <span class="pre">niwa</span></code>.</p>
</div>
<div class="section" id="an-example">
<h2>An Example<a class="headerlink" href="#an-example" title="Permalink to this headline">¶</a></h2>
<p>The following small suite is not portable because all of its tasks are
submitted to a NIWA HPC host; two task are entirely NIWA-specific in that they
respectively install files from a local database and upload products to a local
distribution system; and one task runs a somewhat NIWA-specific configuration
of a model. The remaining tasks are site-agnostic apart from local job host
and batch scheduler directives.</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="nt">[cylc]</span>
    <span class="nv">UTC mode </span><span class="o">=</span><span class="s"> True</span>
<span class="nt">[scheduling]</span>
    <span class="nv">initial cycle point </span><span class="o">=</span><span class="s"> 2017-01-01</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">R1 </span><span class="o">=</span><span class="s"> install_niwa =&gt; preproc</span>
        <span class="nv">P1D </span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            preproc &amp; model[-P1D] =&gt; model =&gt; postproc =&gt; upload_niwa</span>
<span class="s2">            postproc =&gt; idl-1 =&gt; idl-2 =&gt; idl-3</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[root]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> rose task-run -v</span>
    <span class="nt">[[HPC]]</span>  <span class="c1"># NIWA job host and batch scheduler settings.</span>
        <span class="nt">[[[remote]]]</span>
            <span class="nv">host </span><span class="o">=</span><span class="s"> hpc1.niwa.co.nz</span>
        <span class="nt">[[[job]]]</span>
            <span class="nv">batch system </span><span class="o">=</span><span class="s"> loadleveler</span>
        <span class="nt">[[[directives]]]</span>
            <span class="nv">account_no </span><span class="o">=</span><span class="s"> NWP1623</span>
            <span class="nv">class </span><span class="o">=</span><span class="s"> General</span>
            <span class="nv">job_type </span><span class="o">=</span><span class="s"> serial</span>  <span class="c1"># (most jobs in this suite are serial)</span>
    <span class="nt">[[install_niwa]]</span>  <span class="c1"># NIWA-specific file installation task.</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
    <span class="nt">[[preproc]]</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
    <span class="nt">[[model]]</span>  <span class="c1"># Run the model on a local test domain.</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
        <span class="nt">[[[directives]]]</span>  <span class="c1"># Override the serial job_type setting.</span>
            <span class="nv">job_type </span><span class="o">=</span><span class="s"> parallel</span>
        <span class="nt">[[[environment]]]</span>
            <span class="nv">SPEED </span><span class="o">=</span><span class="s"> fast</span>
    <span class="nt">[[postproc]]</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
    <span class="nt">[[upload_niwa]]</span>  <span class="c1"># NIWA-specific product upload.</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
</pre></div>
</div>
<p>To make this portable, refactor it into a core suite.rc file that contains the
clean site-independent workflow configuration and loads all site-specific
settings from an include-file at the end:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># suite.rc: CORE SITE-INDEPENDENT CONFIGURATION.</span>
<span class="cp">{% set SITE = &#39;niwa&#39; %}</span>
<span class="cp">{% from &#39;site/&#39; ~ SITE ~ &#39;-vars.rc&#39; import HAVE_IDL %}</span>
<span class="nt">[cylc]</span>
    <span class="nv">UTC mode </span><span class="o">=</span><span class="s"> True</span>
<span class="nt">[scheduling]</span>
    <span class="nv">initial cycle point </span><span class="o">=</span><span class="s"> 2017-01-01</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">P1D </span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            preproc &amp; model[-P1D] =&gt; model =&gt; postproc</span>
<span class="cp">{% if HAVE_IDL %}</span><span class="s2"></span>
<span class="s2">            postproc =&gt; idl-1 =&gt; idl-2 =&gt; idl-3</span>
<span class="cp">{% endif %}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[root]]</span>
        <span class="nv">script </span><span class="o">=</span><span class="s"> rose task-run -v -O &#39;(</span><span class="cp">{{SITE}}</span><span class="s">)&#39;</span>
    <span class="nt">[[preproc]]</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
    <span class="nt">[[preproc]]</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
    <span class="nt">[[model]]</span>
        <span class="nv">inherit </span><span class="o">=</span><span class="s"> HPC</span>
        <span class="nt">[[[environment]]]</span>
            <span class="nv">SPEED </span><span class="o">=</span><span class="s"> fast</span>
<span class="cp">{% include &#39;site/&#39; ~ SITE ~ &#39;.rc&#39; %}</span>
</pre></div>
</div>
<p>plus site files <code class="docutils literal notranslate"><span class="pre">site/niwa-vars.rc</span></code>:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># site/niwa-vars.rc: NIWA SITE SETTINGS FOR THE EXAMPLE SUITE.</span>
<span class="cp">{% set HAVE_IDL = True %}</span>
</pre></div>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">site/niwa.rc</span></code>:</p>
<div class="highlight-cylc notranslate"><div class="highlight"><pre><span></span><span class="c1"># site/niwa.rc: NIWA SITE SETTINGS FOR THE EXAMPLE SUITE.</span>
<span class="nt">[scheduling]</span>
    <span class="nt">[[graph]]</span>
        <span class="nv">R1 </span><span class="o">=</span><span class="s"> install_niwa =&gt; preproc</span>
        <span class="nv">P1D </span><span class="o">=</span><span class="s"> postproc =&gt; upload_niwa</span>
<span class="nt">[runtime]</span>
    <span class="nt">[[HPC]]</span>
        <span class="nt">[[[remote]]]</span>
            <span class="nv">host </span><span class="o">=</span><span class="s"> hpc1.niwa.co.nz</span>
        <span class="nt">[[[job]]]</span>
            <span class="nv">batch system </span><span class="o">=</span><span class="s"> loadleveler</span>
        <span class="nt">[[[directives]]]</span>
            <span class="nv">account_no </span><span class="o">=</span><span class="s"> NWP1623</span>
            <span class="nv">class </span><span class="o">=</span><span class="s"> General</span>
            <span class="nv">job_type </span><span class="o">=</span><span class="s"> serial</span>  <span class="c1"># (most jobs in this suite are serial)</span>
    <span class="nt">[[install_niwa]]</span>  <span class="c1"># NIWA-specific file installation.</span>
    <span class="nt">[[model]]</span>
        <span class="nt">[[[directives]]]</span>  <span class="c1"># Override the serial job_type setting.</span>
            <span class="nv">job_type </span><span class="o">=</span><span class="s"> parallel</span>
    <span class="nt">[[upload_niwa]]</span>  <span class="c1"># NIWA-specific product upload.</span>
</pre></div>
</div>
<p>and finally, an optional app config file for the local model domain:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>app/model/rose-app.conf  <span class="c1"># Main app config.</span>
app/model/opt/rose-app-niwa.conf  <span class="c1"># NIWA site settings.</span>
</pre></div>
</div>
<p>Some points to note:</p>
<ul class="simple">
<li><p>It is straightforward to extend support to a new site by copying an
existing site file(s) and adapting it to the new job host and batch
scheduler etc.</p></li>
<li><p>Batch system directives should be considered site-specific unless
all supported sites have the same batch system and the same host
architecture (including CPU clock speed and memory size etc.).</p></li>
<li><p>We’ve assumed that all tasks run on a single HPC host at both
sites. If that’s not a valid assumption the <code class="docutils literal notranslate"><span class="pre">HPC</span></code> family
inheritance relationships would have to become site-specific.</p></li>
<li><p>Core task runtime configuration aren’t needed in site files at all
if their job host and batch system settings can be defined in common
families that are (<code class="docutils literal notranslate"><span class="pre">HPC</span></code> in this case).</p></li>
</ul>
</div>
<div class="section" id="collaborative-development-model">
<span id="id2"></span><h2>Collaborative Development Model<a class="headerlink" href="#collaborative-development-model" title="Permalink to this headline">¶</a></h2>
<p>Official releases of a portable suite should be made from the suite trunk.</p>
<p>Changes should be developed on feature branches so as not to affect other users
of the suite.</p>
<p>Site-specific changes shouldn’t touch the core suite.rc file, just the relevant
site include-file, and therefore should not need close scrutiny from other
sites.</p>
<p>Changes to the core suite.rc file should be agreed by all stakeholders, and
should be carefully checked for effects on site include-files:</p>
<ul class="simple">
<li><p>Changing the name of tasks or families in the core suite may break
sites that add configuration to the original runtime namespace.</p></li>
<li><p>Adding new tasks or families to the core suite may require
corresponding additions to the site files.</p></li>
<li><p>Deleting tasks or families from the core suite may require
corresponding parts of the site files to be removed. And also, check for
site-specific triggering off of deleted tasks or families.</p></li>
</ul>
<p>However, if the owner site has to get some changes into the trunk before all
collaborating sites have time to test them, version control will of course
protect those lagging behind from any immediate ill effects.</p>
<p>When a new feature is complete and tested at the developer’s site, the suite
owner should check out the branch, review and test it, and if necessary request
that other sites do the same and report back. The owner can then merge the
new feature to the trunk once satisfied.</p>
<p>All planning and discussion associated with the change should be documented on
MOSRS Trac tickets associated with the suite.</p>
</div>
<div class="section" id="research-to-operations-transition">
<h2>Research-To-Operations Transition<a class="headerlink" href="#research-to-operations-transition" title="Permalink to this headline">¶</a></h2>
<p>Under this collaborative development model it is <em>possible</em> to use the
same suite in research and operations, largely eliminating the difficult
translation between the two environments. Where appropriate, this can save
a lot of work.</p>
<p>Operations-specific parts of the suite should be factored out (as for site
portability) into include-files that are only loaded in the operational
environment. Improvements and upgrades can be developed on feature branches in
the research environment. Operations staff can check out completed feature
branches for testing in the operational environment before merging to trunk or
referring back to research if problems are found. After sufficient testing the
new suite version can be deployed into operations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This obviously glosses over the myriad complexities of the technical
and scientific testing and validation of suite upgrades; it merely describes
what is possible from a suite design and collaborative development
perspective.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="roadmap.html" class="btn btn-neutral float-right" title="Roadmap" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="efficiency.html" class="btn btn-neutral float-left" title="Efficiency And Maintainability" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2008-2020 NIWA &amp; British Crown (Met Office) &amp; Contributors
      <span class="lastupdated">
        Last updated on Aug 11, 2020.
      </span>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <!--
  element which gets populated with the list of available versions and
  formats for the documentation by versions.js
-->
<div
  class="rst-versions"
  data-toggle="rst-versions"
  id='versions-and-formats'
></div>



<script type="text/javascript">
    const CUR_FORMAT = "html";
    const CUR_VERSION = "nightly.2020-08-11";
    // name of page (in URL), for singlepage builds this will be `index`
    const PAGE_NAME = "suite-design-guide/portable-suites";
    // URL path to the base docs dir i.e. ROOT_DIR/version/format
    const ROOT_DIR = "../../..";
</script>

<script
  type="text/javascript"
  src="../../../versions.js"
></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>